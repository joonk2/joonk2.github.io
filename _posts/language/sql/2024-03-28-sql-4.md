---
title:  "SQL_4 (python í™œìš©)"
layout: post
categories: [language, sql]
tags: [sql, ì œë¡œë² ì´ìŠ¤]
toc: true
toc_sticky: true
date: 2024-03-28
---

<!-- MathJax Script for this post only -->
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
      processEscapes: true
    }
  });
</script>

#### ğŸ™…â€â™‚ï¸íœ´ëŒ€í°ìœ¼ë¡œ ë³¼ ë•Œ í˜¹ì‹œ ê¸€ìë‚˜ ìˆ«ìê°€ í™”ë©´ì— ë‹¤ ì•ˆë‚˜ì˜¤ë©´<span style="color:red">**,**</span> íœ´ëŒ€í° ê°€ë¡œë¡œ ëŒë¦¬ì‹œë©´ ë©ë‹ˆë‹¤


```md
<ëª©ì°¨>

1. ì´ˆê¸°ì„¸íŒ…
2. excute
3. fetchall
4. ì˜ˆì œ
 4-1) police_station
 4-2) 2020_crime
 4-3) seoul_CCTV
```

*ì´ë²ˆ ê¸€ì—ì„œëŠ” pythonê³¼ sqlì„ í•¨ê»˜ í™œìš©í•©ë‹ˆë‹¤

# 1. ì´ˆê¸°ì„¸íŒ…
AWS RDSì—ì„œ ì‘ì—…í•  ë•ŒëŠ” `--set-gtid-purged=OFF` í•„ìˆ˜! <br>
(ì™œëƒí•˜ë©´ ì €ê±° ì—†ì„ ë•Œ, ì‹¤í–‰ ì‹œSQLíŒŒì¼ì— ë‹¤ë¥¸ ì˜µì…˜ì´ ë“¤ì–´ê°€ ì˜¤ë¥˜ë‚œë‹¤í•¨)
```sql
------------------ ì„¸íŒ… --------------------------------------
# ê²½ë¡œ ì´ë™
cd C:/Users/withj/Documents/sql_ws
â¡ï¸ë¨¼ì € vscodeì˜ backup_police.sql ì œê±°

# ë°±ì—…
mysqldump --set-gtid-purged=OFF -h "ì•„ë§ˆì¡´ ì£¼ì†Œ" -P 3306 -u admin -p zerobase police_station > backup_police.sql

# ë¡œê·¸ì¸
mysql -h "ì•„ë§ˆì¡´ ì£¼ì†Œ" -P 3306 -u admin -p --default-character-set=utf8mb4

# í™•ì¸
show databases;
use zerobase;
show tables;

# police_station ì‚­ì œí›„ í™•ì¸
delete from police_station;
select * from police_station;

# ê°™ì€ ê²½ë¡œì˜ vscodeì—ì„œ python.ipynb ìƒì„±
ã„±ã„±
```
<br><br><br><br>

# 2. excute
ìš°ì„  ì´ê²ƒ ì„¤ì¹˜ `!pip install mysql-connector-python`
```py
# ì¦‰ì„ìœ¼ë¡œ íŒŒì¼ ìƒì„±
cur.execute("CREATE TABLE sql_file (id int, filename varchar(16))")

# ì¦‰ì„ìœ¼ë¡œ íŒŒì¼ ì‚­ì œ
cur.execute("DROP TABLE sql_file")

# ì½ê¸° ëª¨ë“œ
sql = open("test3.sql").read()
cur.execute(sql)
```

## ì½”ë“œ ì‘ì„±
local, aws 2ê°œë¡œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

### local ì—°ê²°
```python
# local ì—°ê²°
import mysql.connector as mc

local = mc.connect(
    host = "localhost",
    user = "root",
    password = "****",
    database = "zerobase"
)


# ì‚¬ìš©ë‹¤í•˜ë©´ ì¢…ë£Œ
local.close()
```

### AWS ì—°ê²°
### (1) query ìƒì„±
```python
# AWS ì—°ê²°
remote = mc.connect(
    host = "ì•„ë§ˆì¡´ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)



# query ì§ì ‘ ìƒì„±
cur = remote.cursor()
cur.execute("CREATE TABLE sql_file (id int, filename varchar(16))")



# ì‚¬ìš©ë‹¤í•˜ë©´ ì¢…ë£Œ
remote.close()
```
ê·¸ë¦¬ê³  awsë¡œ ë¡œê·¸ì¸í•œ mysqlì—ì„œ `desc sql_file` ì…ë ¥í•˜ì—¬ í™•ì¸
<br>

### (2) query ì‚­ì œ
```python
# AWS ì—°ê²°
remote = mc.connect(
    host = "ì•„ë§ˆì¡´ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)


# query ì‚­ì œ
cur = remote.cursor()
cur.execute("DROP TABLE sql_file")


# ì‚¬ìš©ë‹¤í•˜ë©´ ì¢…ë£Œ
remote.close()
```
ê·¸ë¦¬ê³  awsë¡œ ë¡œê·¸ì¸í•œ mysqlì—ì„œ `desc sql_file` ì…ë ¥í•˜ì—¬ í™•ì¸
<br>

### (3) ì¿¼ë¦¬ ì‹¤í–‰
sql íŒŒì¼ì„ í•˜ë‚˜ ë§Œë“¤ê³  pyë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤
```python
# test3.sql

CREATE TABLE sql_file
(
    id int,
    filename varchar(16)
);
```

```python
# python.ipynb

remote = mc.connect(
    host = "ì•„ë§ˆì¡´ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)

# test3.sql ì‹¤í–‰
cur = remote.cursor()
sql = open("test3.sql").read()
cur.execute(sql)

# ì‚¬ìš©ë‹¤í•˜ë©´ ì¢…ë£Œ
remote.close()
```
ëë‚¬ìœ¼ë©´ AWS mysql ë¡œê·¸ì¸, <br>
ê·¸ë¦¬ê³  í™•ì¸`show databases;`â€”>`use zerobase;`â€”>`show tables;`â€”>`desc sql_file;`
<br><br><br>

# 3. fetchall
SQL ì¿¼ë¦¬ì˜ ê²°ê³¼ ì§‘í•©ì—ì„œ ëª¨ë“  í–‰ì„ ê°€ì ¸ì˜´
### ğŸ”—sql file ë‚´ì— queryê°€ ì—¬ëŸ¬ê°œ ì¡´ì¬í•˜ëŠ” ê²½ìš°
test4.sql, python.ipynb í™œìš©
```python
# test4.sql

INSERT INTO sql_file VALUES (1, "test1.sql");
INSERT INTO sql_file VALUES (2, "test2.sql");
INSERT INTO sql_file VALUES (3, "test3.sql");
INSERT INTO sql_file VALUES (4, "test4.sql");
```

```python
# python.ipynb

remote = mc.connect(
    host = "ì•„ë§ˆì¡´ ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)



# ê°ê°ì˜ ì¿¼ë¦¬ê°€ ê²°ê³¼ë¬¸ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒ í™•ì¸
# buffered=True --> ì½ì–´ì˜¬ ë°ì´í„° ì–‘ì´ ë§ì„ ë•Œ 
cur = remote.cursor(buffered=True)
cur.execute("SELECT * FROM sql_file")
result = cur.fetchall()
for result_iterator in result:
    print(result_iterator)



# ì‚¬ìš©ë‹¤í•˜ë©´ ì¢…ë£Œ
remote.close()
```
ì™„ë£Œ í›„ `show databases;`->`use zerobase;`->`show tables;`->`desc sql_file;`->
`select * from sql_file;` ì…ë ¥ ì‹œ ì†Œì†ëœ sql íŒŒì¼ë“¤ í™•ì¸ ê°€ëŠ¥

### mysqlì„ pandasë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
```python
# python.ipynb
 
import pandas as pd
df =pd.DataFrame(result)
df.head()
```
<br><br><br><br>

# 4. ì˜ˆì œ
```python
# EDA ìˆ˜ì—…ë•Œ ì‚¬ìš©í•œ police_station.csv, 2020_crime.csv, seoul_CCTV.csv ê°€ì ¸ì˜¤ê¸°
ì•„ë˜ì— ëŒ€ì‘ë˜ëŠ” 2ê°œì˜ ì»¬ëŸ¼ê°’ë“¤ì´ ê°ê° í•„ìš”í•©ë‹ˆë‹¤ 
```

## 4-1) police_station
![Desktop View](/assets/img//language/sql/sql4/1.png)
![Desktop View](/assets/img//language/sql/sql4/2.png)
```python
# python.ipynb

#1 csv ë¶ˆëŸ¬ì˜¤ê¸°
import pandas as pd
df =pd.read_csv("./police_station.csv")
df.head()

#2 mysql ì—°ê²°
import mysql.connector
mconn = mysql.connector.connect(
    host = "ì•„ë§ˆì¡´ ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)

# ----------------- ì½ì–´ì˜¬ ë°ì´í„° ì„¤ì • ----------------------------
#(buffered=True --> ì½ì–´ì˜¬ ë°ì´í„° ì–‘ì´ ë§ì„ ë•Œ)
cursor = mconn.cursor(buffered=True)

#3 insertì¿¼ë¦¬ ì‘ì„± (ê°’ 2ê°œ)
sql = "insert into police_station values (%s, %s)"

#4 ë°ì´í„°ë¥¼ police_station í…Œì´ë¸”ì— insert
# commit (dbì— ì ìš©í•˜ê¸° ìœ„í•œ ëª…ë ¹)
# (ì²˜ìŒì´ listí˜•íƒœì˜€ìœ¼ë‹ˆê¹Œ forë¬¸ì„ í†µí•´ íŠœí”Œí˜•íƒœë¡œ 1ê°œì”© ì¶”ì¶œ)
for i, row in df.iterrows():
    cursor.execute(sql, tuple(row))
    print(tuple(row))
    mconn.commit()

#5 ê²°ê³¼ í™•ì¸ ë° ì €ì¥
cursor.execute("select * from police_station")
result = cursor.fetchall()

#6 pandas ì½ê¸°
df = pd.DataFrame(result)
df.tail()
```
<br>

## 4-2) 2020_crime
![Desktop View](/assets/img//language/sql/sql4/3.png)

```python
#1 csv ë¶ˆëŸ¬ì˜¤ê¸°
import pandas as pd
df =pd.read_csv("./2020_crime.csv", encoding="euc-kr")
df.head(2)

#2 mysql ì—°ê²°
import mysql.connector
mconn = mysql.connector.connect(
    host = "ì•„ë§ˆì¡´ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë°€ë²ˆí˜¸",
    database = "zerobase"
)


# ----------------- ì½ì–´ì˜¬ ë°ì´í„° ì„¤ì • ----------------------------
#(buffered=True --> ì½ì–´ì˜¬ ë°ì´í„° ì–‘ì´ ë§ì„ ë•Œ)
#3 insert ì¿¼ë¦¬ ì‘ì„±
sql = "insert into crime_status values ('2020', %s, %s, %s, %s)"
cursor = mconn.cursor(buffered=True)


#4 ë°ì´í„°ë¥¼ crime_status í…Œì´ë¸”ì— insert
for i, row in df.iterrows():
    cursor.execute(sql, tuple(row))
    print(tuple(row))
    mconn.commit()


#5 crime_status í…Œì´ë¸”ì˜ ë°ì´í„° ì¡°íšŒ
cursor.execute("select * from crime_status")
result = cursor.fetchall()
for row in result:
    print(row)


#6 ì¡°íšŒí•œ ê²°ê³¼ë¥¼ DataFrameìœ¼ë¡œ í™•ì¸
df = pd.DataFrame(result)
df.head(2)    
```
<br>

## 4-3) seoul_CCTV
![Desktop View](/assets/img//language/sql/sql4/4.png)

```python
# ------------------------- python.ipynb ------------------------------

#1 seoul_CCTV.csv
import pandas as pd
df = pd.read_csv('./seoul_CCTV.csv')
df.head(2)

#2 mysql ì—°ê²°
import mysql.connector
mconn = mysql.connector.connect(
    host = "ì•„ë§ˆì¡´ì£¼ì†Œ",
    port  = 3306,
    user = 'admin',
    password = "ë¹„ë²ˆ",
    database = "zerobase"
)

#3 insert ì¿¼ë¦¬ ì‘ì„±
sql = "CREATE TABLE cctv (ê¸°ê´€ëª… varchar(8), ì†Œê³„ int, 2013ë…„ë„ì´ì „ int, 2014ë…„ int, 2015ë…„ int, 2016ë…„ int)"
cursor = mconn.cursor(buffered=True)
cursor.execute(sql)
# ì˜ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë°©ë²•â¬‡ï¸
# ì•„ë§ˆì¡´ ë¡œê·¸ì¸ -> use zerobase; -> show tables; -> desc cctv;

#4 ë°ì´í„°ë¥¼ cctv í…Œì´ë¸”ì— insert
sql = "INSERT INTO cctv values (%s, %s, %s, %s, %s, %s)"
cursor = mconn.cursor(buffered=True)
for i, row in df.iterrows():
    cursor.execute(sql, tuple(row))
    print(tuple(row))
    mconn.commit()

#5 cctv í…Œì´ë¸”ì˜ ë°ì´í„° ì¡°íšŒ
cursor.execute("SELECT * FROM cctv")
result = cursor.fetchall()
for row in result:
    print(row)

#6 pandasë¡œ ì¡°íšŒ
df = pd.DataFrame(result)
df.head(2)
```